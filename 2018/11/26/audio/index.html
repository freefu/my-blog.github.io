<!DOCTYPE html>


  <html class="light page-post">


<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>有关audio的一些事 | Undefined</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="javascript,">
  

  <meta name="description" content="前言之前有做过一些跟audio相关的工作，大多数是h5页面中引入bgm，音效，在这里总结一下之前遇见的问题和解决的办法以及一些优化用户体验的实践。 audio标签以前的项目中使用方法1&amp;lt;audio src=&quot;http://static.guobaoyoo.com/mp3/naonao/bgm.mp3&quot; autoplay=&quot;autoplay&quot; controls=&quot;controls&quot; loop=">
<meta name="keywords" content="javascript">
<meta property="og:type" content="article">
<meta property="og:title" content="有关audio的一些事">
<meta property="og:url" content="https://blog.guobaoyoo.com/2018/11/26/audio/index.html">
<meta property="og:site_name" content="Undefined">
<meta property="og:description" content="前言之前有做过一些跟audio相关的工作，大多数是h5页面中引入bgm，音效，在这里总结一下之前遇见的问题和解决的办法以及一些优化用户体验的实践。 audio标签以前的项目中使用方法1&amp;lt;audio src=&quot;http://static.guobaoyoo.com/mp3/naonao/bgm.mp3&quot; autoplay=&quot;autoplay&quot; controls=&quot;controls&quot; loop=">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-11-27T05:38:25.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="有关audio的一些事">
<meta name="twitter:description" content="前言之前有做过一些跟audio相关的工作，大多数是h5页面中引入bgm，音效，在这里总结一下之前遇见的问题和解决的办法以及一些优化用户体验的实践。 audio标签以前的项目中使用方法1&amp;lt;audio src=&quot;http://static.guobaoyoo.com/mp3/naonao/bgm.mp3&quot; autoplay=&quot;autoplay&quot; controls=&quot;controls&quot; loop=">

  

  
    <link rel="icon" href="/images/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  

  


  

</head>
</html>
<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">导航</span>
  

  <div class="post-header LEFT">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">导航</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/archives/" rel="noopener noreferrer" target="_self">
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/category/" rel="noopener noreferrer" target="_self">
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/tag/" rel="noopener noreferrer" target="_self">
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/link/" rel="noopener noreferrer" target="_self">
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/about/" rel="noopener noreferrer" target="_self">
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/search/" rel="noopener noreferrer" target="_self">
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#audio标签"><span class="toc-text">audio标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#之前项目需求"><span class="toc-text">之前项目需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部分代码"><span class="toc-text">部分代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#遇见问题以及解决办法"><span class="toc-text">遇见问题以及解决办法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-Audio-API-AudioContext"><span class="toc-text">Web Audio API AudioContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#探索遗留问题"><span class="toc-text">探索遗留问题</span></a></li></ol>
  </div>



<div class="content content-post LEFT">
   <article id="post-audio" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">有关audio的一些事</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2018.11.26</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Freefu</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/article/">article</a>
  </span>



      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>之前有做过一些跟audio相关的工作，大多数是h5页面中引入bgm，音效，在这里总结一下之前遇见的问题和解决的办法以及一些优化用户体验的实践。</p>
<h3 id="audio标签"><a href="#audio标签" class="headerlink" title="audio标签"></a>audio标签</h3><p>以前的项目中使用方法<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">audio</span> <span class="attr">src</span>=<span class="string">"http://static.guobaoyoo.com/mp3/naonao/bgm.mp3"</span> <span class="attr">autoplay</span>=<span class="string">"autoplay"</span> <span class="attr">controls</span>=<span class="string">"controls"</span> <span class="attr">loop</span>=<span class="string">"loop"</span>&gt;</span><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="之前项目需求"><a href="#之前项目需求" class="headerlink" title="之前项目需求"></a>之前项目需求</h3><p>第一种：页面加载后，自动播放bgm<br>第二种：为点击添加音效</p>
<h3 id="部分代码"><a href="#部分代码" class="headerlink" title="部分代码"></a>部分代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=<span class="string">"http://static.guobaoyoo.com/mp3/naonao/bgm.mp3"</span> id=<span class="string">"myAudio"</span> autoplay=<span class="string">"autoplay"</span> controls=<span class="string">"controls"</span> loop=<span class="string">"loop"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> audio = <span class="built_in">document</span>.getElementById(<span class="string">'myAudio'</span>)</span><br><span class="line">audio.currentTime = <span class="number">0</span></span><br><span class="line">audio.play()</span><br></pre></td></tr></table></figure>
<h3 id="遇见问题以及解决办法"><a href="#遇见问题以及解决办法" class="headerlink" title="遇见问题以及解决办法"></a>遇见问题以及解决办法</h3><blockquote>
<p>Note: Sites that automatically play audio (or videos with an audio track) can be an unpleasant experience for users, so should be avoided when possible. If you must offer autoplay functionality, you should make it opt-in (requiring a user to specifically enable it). However, this can be useful when creating media elements whose source will be set at a later time, under user control.  </p>
</blockquote>
<p>mdn上给出的note，大概意思就是尽量避免使用autoplay，如果不得不用的话，应该让用户做操作，所以产品产出调整，页面加载后触发用户一个行为后让audio加载，完事再播放就ok了，<code>但是需要让用户做出操作</code>。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=<span class="string">"http://static.guobaoyoo.com/mp3/naonao/bgm.mp3"</span> id=<span class="string">"myAudio"</span> autoplay=<span class="string">"autoplay"</span> controls=<span class="string">"controls"</span> loop=<span class="string">"loop"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">audio</span>&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> audio = <span class="built_in">document</span>.getElementById(<span class="string">'myAudio'</span>)</span><br><span class="line"><span class="comment">// 在这里用户的一个行为触发，比如是个页面click事件</span></span><br><span class="line"><span class="built_in">document</span>.body.addEventListener(<span class="string">'click'</span>,<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  audio.load()</span><br><span class="line">&#125;, <span class="literal">false</span>)</span><br><span class="line">audio.currentTime = <span class="number">0</span></span><br><span class="line">audio.play()</span><br></pre></td></tr></table></figure></p>
<h3 id="Web-Audio-API-AudioContext"><a href="#Web-Audio-API-AudioContext" class="headerlink" title="Web Audio API AudioContext"></a>Web Audio API AudioContext</h3><blockquote>
<p>Web Audio API 提供了在Web上控制音频的一个非常有效通用的系统，允许开发者来自选音频源，对音频添加特效，使音频可视化，添加空间效果 （如平移），等等。</p>
</blockquote>
<p>api接口比较多，也没有一条一条具体去看，针对我想要的，引入第三方资源，然后控制播放，停止播放等等。</p>
<p>上代码<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> AudioContext = <span class="built_in">window</span>.AudioContext || <span class="built_in">window</span>.webkitAudioContext</span><br><span class="line"><span class="keyword">let</span> audioCtx = AudioContext ? <span class="keyword">new</span> AudioContext() : <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bgmBuffer = &#123;</span><br><span class="line">  getBuffer (link) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (audioCtx) &#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="keyword">new</span> XMLHttpRequest()</span><br><span class="line">        request.open(<span class="string">'GET'</span>, link, <span class="literal">true</span>)</span><br><span class="line">        request.responseType = <span class="string">'arraybuffer'</span></span><br><span class="line">        request.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          audioCtx.decodeAudioData(request.response, <span class="function"><span class="keyword">function</span> (<span class="params">buffer</span>) </span>&#123;</span><br><span class="line">            resolve(buffer)</span><br><span class="line">          &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'reject'</span>)</span><br><span class="line">            reject(e)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        request.send()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'not support AudioContext'</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  createSound (buffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (audioCtx.state === <span class="string">'suspended'</span>) &#123;</span><br><span class="line">      audioCtx.suspend().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'重启audioCtx'</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> source = audioCtx.createBufferSource()</span><br><span class="line">    source.buffer = buffer</span><br><span class="line">    source.connect(audioCtx.destination)</span><br><span class="line">    <span class="keyword">return</span> source</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> bgmBuffer</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Audio <span class="keyword">from</span> <span class="string">'@/utils/audio'</span></span><br><span class="line">data () &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    transitionName: <span class="string">''</span>,</span><br><span class="line">    bgmBuffer: <span class="literal">null</span>,</span><br><span class="line">    bgmSound: <span class="literal">null</span>,</span><br><span class="line">    audioPlaying: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">computed: &#123;</span><br><span class="line">  playing () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$store.state.audioPlaying</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  getBgmSound () &#123;</span><br><span class="line">    Audio.getBuffer(<span class="string">'http://static.guobaoyoo.com/mp3/naonao/bgm.mp3'</span>).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.bgmBuffer = res</span><br><span class="line">      <span class="keyword">this</span>.bgmPlay(res)</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(err)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line">  bgmPlay (buffer) &#123;</span><br><span class="line">    <span class="keyword">this</span>.bgmSound = Audio.createSound(buffer)</span><br><span class="line">    <span class="keyword">this</span>.bgmSound.loop = <span class="literal">true</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.bgmSound)</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.bgmSound !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.bgmSound.start()</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'BGM_PLAY'</span>, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  bgmStop () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.bgmSound !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.bgmSound.stop()</span><br><span class="line">      <span class="keyword">this</span>.$store.commit(<span class="string">'BGM_PLAY'</span>, <span class="literal">false</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  bgmControl () &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.playing)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.playing) &#123;</span><br><span class="line">      <span class="keyword">this</span>.bgmPlay(<span class="keyword">this</span>.bgmBuffer)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.bgmStop()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="keyword">this</span>.getBgmSound()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="探索遗留问题"><a href="#探索遗留问题" class="headerlink" title="探索遗留问题"></a>探索遗留问题</h3><ul>
<li>放到手机中还是不能自动播放</li>
<li>不能暂停</li>
</ul>

    
  </div>

</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持forsigner</div>
        <ul>
        
          <li class="item">
            
              <span>微信扫一扫</span>
            
            <img src="/images/qr-wechat.png" alt="">
          </li>
        
          <li class="item">
            
              <span>支付宝扫一扫</span>
            
            <img src="/images/qr-alipay.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2018/11/25/markdown/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="hide pull-right" href="/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/archives/" rel="noopener noreferrer" target="_self">
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/category/" rel="noopener noreferrer" target="_self">
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/tag/" rel="noopener noreferrer" target="_self">
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/link/" rel="noopener noreferrer" target="_self">
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/about/" rel="noopener noreferrer" target="_self">
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/search/" rel="noopener noreferrer" target="_self">
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

<!-- Gitalk评论插件通用代码 -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
const gitalk = new Gitalk({
  clientID: '2a7a8cf241a8541c7e30',
  clientSecret: '8a73bbd035682f6c80f93063b30338470abe3d48',
  repo: 'my-blog.github.io',
  owner: 'freefu',
  // 在这里设置一下截取前50个字符串, 这是因为 github 对 label 的长度有了要求, 如果超过
  // 50个字符串则会报错.
  id: location.pathname.split('/').pop().substring(0, 49),
  admin: ['freefu'],
  // facebook-like distraction free mode
  distractionFreeMode: false
})
gitalk.render('gitalk-container')
</script>
<!-- Gitalk代码结束 -->



  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
